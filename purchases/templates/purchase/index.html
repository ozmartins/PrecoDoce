{% extends "base.html" %}
{% load static %}
{% block content %}
<main class="container my-4">

    <!-- Hidden csrf so JS can read it if cookie is not present -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />

    <div class="card mb-4">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
            <h1 class="h5 mb-0">Purchases</h1>

            <div class="d-flex align-items-center gap-2">
                <form class="d-flex" method="get" action="">
                    <input type="search" name="q" value="{{ request.GET.q|default:'' }}" class="form-control"
                        placeholder="Search by supplier..." aria-label="Search purchases">
                    <button class="btn btn-outline-secondary ms-2" type="submit">Search</button>
                </form>

                <a href="{% url 'purchases:purchase_create' %}" class="btn btn-primary">+ New purchase</a>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table id="purchases-table" class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width:96px;"></th>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th class="text-end">Total</th>
                        <th style="width:220px;" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if purchases %}
                    {% for p in purchases %}
                    <tr data-id="{{ p.id }}">
                        <td class="text-muted">#{{ p.id }}</td>
                        <td>{{ p.date }}</td>
                        <td>{{ p.supplier.name }}</td>
                        <td class="text-end">R$ {{ p.total|floatformat:2 }}</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-edit-purchase"
                                data-id="{{ p.id }}" data-name="#{{ p.id }} — {{ p.supplier.name }}">
                                Edit
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-purchase"
                                data-id="{{ p.id }}" data-name="#{{ p.id }} — {{ p.supplier.name }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="empty-row">
                        <td colspan="5" class="text-center text-muted py-4">No purchases found.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if page_obj %}
        <div class="card-body">
            <nav aria-label="Purchases pagination">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
                            aria-label="Previous">«</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">«</span></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if num == page_obj.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                            aria-label="Next">»</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">»</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Delete confirmation modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-white">
                    <h5 class="modal-title" id="modalLabel">Confirm deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the purchase <strong id="del-name"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080;"></div>

    <script type="module">
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts);
        const delegate = (root, ev, sel, fn) => on(root, ev, e => { const t = e.target.closest(sel); if (t && root.contains(t)) fn(e, t); });

        const escapeHtml = t => String(t ?? "").replace(/[&<>"'`=\/]/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;" }[s] || s));

        const toast = (msg, type = "success") => {
            const id = `alert-${Date.now()}`;
            const html = `<div id="${id}" class="alert alert-${type} alert-dismissible fade show mt-3 shadow-sm" role="alert">${escapeHtml(msg)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            $("#alert-container")?.insertAdjacentHTML("beforeend", html);
            setTimeout(() => document.getElementById(id)?.remove(), 3500);
        };

        const getCookie = name => (document.cookie?.split(";") || []).map(c => c.trim()).find(c => c.startsWith(name + "="))?.split("=")[1] || null;
        const getCsrfToken = () => document.querySelector("input[name=csrfmiddlewaretoken]")?.value || decodeURIComponent(getCookie("csrftoken") || "");

        const http = async (url, { method = "GET", body, headers = {} } = {}) => {
            const res = await fetch(url, { method, headers: { "X-Requested-With": "XMLHttpRequest", ...(method !== "GET" ? { "X-CSRFToken": getCsrfToken() } : {}), ...headers }, body });
            let data = null; try { data = await res.json(); } catch { }
            return { ok: res.ok, status: res.status, data };
        };

        const tbody = $("#purchases-table tbody");
        const modalEl = $("#confirmDeleteModal");
        const modal = () => bootstrap.Modal.getOrCreateInstance(modalEl);

        const ensureEmptyRowIfNeeded = () => { if (!tbody?.querySelector("tr")) { tbody.insertAdjacentHTML("beforeend", `<tr class="empty-row"><td colspan="5" class="text-center text-muted py-4">No purchases found.</td></tr>`); } };

        const removeRow = id => document.querySelector(`tr[data-id="${CSS.escape(String(id))}"]`)?.remove();

        const initDelete = () => {
            const nameHolder = $("#del-name");
            const btnConfirm = $("#btnConfirmDelete");
            let selectedId = null;

            delegate(document, "click", ".btn-delete-purchase", (_e, btn) => {
                selectedId = btn.dataset.id || "";
                if (nameHolder) nameHolder.textContent = btn.dataset.name || `#${selectedId}`;
                modal().show();
            });

            on(btnConfirm, "click", async () => {
                const id = (selectedId || "").trim();
                if (!id) return;
                try {
                    const url = `{% url 'purchases:purchase_delete' 0 %}`.replace("0", encodeURIComponent(id));
                    const { ok } = await http(url, { method: "POST" });
                    if (ok) {
                        removeRow(id);
                        ensureEmptyRowIfNeeded();
                        toast("Purchase successfully deleted!");
                    } else {
                        toast("Error while deleting purchase.", "danger");
                    }
                } catch {
                    toast("Failed to communicate with the server.", "danger");
                } finally {
                    modal().hide();
                    selectedId = null;
                }
            });

            on(modalEl, "shown.bs.modal", () => btnConfirm?.focus());
        };

        document.addEventListener("DOMContentLoaded", initDelete);

        const editDelegate = (root, ev, sel, fn) => root.addEventListener(ev, e => { const t = e.target.closest(sel); if (t && root.contains(t)) fn(e, t); });

        document.addEventListener("DOMContentLoaded", () => {
            console.log('btn-edit-purchase')
            editDelegate(document, "click", ".btn-edit-purchase", (_e, btn) => {
                const id = btn.dataset.id;
                if (id) {
                    const url = `{% url 'purchases:purchase_update' 0 %}`.replace("0", encodeURIComponent(id));
                    window.location.href = url;
                }
            });
        });        
    </script>
</main>
{% endblock content %}