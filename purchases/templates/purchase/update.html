{# templates/purchases/edit.html #}
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="card mb-4">
    <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
        <h1 class="h5 mb-0">Edit Purchase #{{ purchase.id }}</h1>
    </div>
</div>

<form id="purchaseForm" class="card" method="post" action="{% url 'purchases:purchase_update' purchase.id %}">
    {% csrf_token %}
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-8">
                <div class="col-md-8 position-relative">
                    <label for="supplier-input" class="form-label">Supplier</label>
                    <input id="supplier-input" type="text" class="form-control" autocomplete="off"
                        placeholder="Type the supplier name" aria-autocomplete="list" aria-controls="supplier-suggest"
                        aria-expanded="false" value="{{ purchase.supplier.name }}">
                    <input type="hidden" id="supplier-id" name="supplier" value="{{ purchase.supplier.id }}">
                    <div id="supplier-suggest" class="list-group position-absolute w-100 d-none" role="listbox"
                        style="z-index: 1050; max-height: 260px; overflow: auto;"></div>
                    <div id="supplier-error" class="invalid-feedback d-block d-none">Select a supplier.</div>
                </div>
            </div>
            <div class="col-md-2 ms-auto">
                <div class="d-flex flex-column align-items-start">
                    <label for="purchase-date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="purchase-datetime" name="date" required
                        value="{{ purchase.date|date:'Y-m-d' }}">
                </div>
            </div>
        </div>
    </div>

    <div class="card-body border-top">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h6 mb-0">Items</h2>
            <button type="button" class="btn btn-primary" id="btnAddItem">+ Add item</button>
        </div>

        <div class="table-responsive">
            <table id="items-table" class="table align-middle">
                <thead>
                    <tr>
                        <th style="width: 50%;">Ingredient</th>
                        <th style="width: 9%;">Unit</th>
                        <th style="width: 9%;">Quantity</th>
                        <th style="width: 18%;">Item total</th>
                        <th style="width: 14%;" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="items-body">
                    {% if purchase_items %}
                    {% for it in purchase_items %}
                    <tr data-row="1">
                        <td>
                            <div class="position-relative">
                                <input type="text" class="form-control ingredient-input" autocomplete="off"
                                    placeholder="Type the ingredient name" value="{{ it.ingredient.name }}"
                                    aria-autocomplete="list" aria-expanded="false">
                                <input type="hidden" class="ingredient-id" name="ingredient_id"
                                    value="{{ it.ingredient.id }}">
                                <div class="list-group position-absolute w-100 d-none ingredient-suggest" role="listbox"
                                    style="z-index:1050; max-height:260px; overflow:auto;"></div>
                                <div class="invalid-feedback d-block d-none ingredient-error">Select an ingredient.
                                </div>
                            </div>
                        </td>
                        <td>
                            <select class="form-select" name="metric_system_unit" required>
                                <option disabled>Select unit...</option>
                                {% if it.metric_system_unit == 1 %}
                                <option value="1" selected>un</option>
                                {% else %}
                                <option value="1">un</option>
                                {% endif %}

                                {% if it.metric_system_unit == 2 %}
                                <option value="2" selected>kg</option>
                                {% else %}
                                <option value="2">kg</option>
                                {% endif %}

                                {% if it.metric_system_unit == 3 %}
                                <option value="3" selected>g</option>
                                {% else %}
                                <option value="3">g</option>
                                {% endif %}

                                {% if it.metric_system_unit == 4 %}
                                <option value="4" selected>mg</option>
                                {% else %}
                                <option value="4">mg</option>
                                {% endif %}

                                {% if it.metric_system_unit == 5 %}
                                <option value="5" selected>L</option>
                                {% else %}
                                <option value="5">L</option>
                                {% endif %}

                                {% if it.metric_system_unit == 6 %}
                                <option value="6" selected>ml</option>
                                {% else %}
                                <option value="6">ml</option>
                                {% endif %}
                            </select>
                        </td>
                        <td>
                            <input class="form-control text-end" step="0.01" min="0" name="quantity" required
                                value="{{ it.quantity }}">
                        </td>
                        <td>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" class="form-control text-end item-total-input" name="item_total"
                                    required placeholder="0,00" value="{{ it.total }}">
                            </div>
                        </td>
                        <td class="text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm btn-remove">Remove</button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="empty-row">
                        <td colspan="5" class="text-center text-muted py-4">No items yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="col-md-3">
                <div class="input-group">
                    <label for="purchase-total" class="input-group-text bg-white border-end-0 fw-semibold">Total</label>
                    <span class="input-group-text border-start-0 border-end-0">$</span>
                    <input type="number" step="0.01" min="0" class="form-control text-end" id="purchase-total"
                        name="total" readonly value="{{ purchase.total }}">
                </div>
            </div>
        </div>

        <input type="hidden" name="items_json" id="items-json">
        <div id="items-error" class="alert alert-danger d-none mt-3"></div>
    </div>

    <div class="card-body border-top d-flex justify-content-end gap-2">
        <a href="{% url 'purchases:purchase_recover' %}" class="btn btn-outline-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary" id="btnSubmitPurchase">Update purchase</button>
    </div>
</form>

<div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080;">
    {% if form and form.errors %}
    <div class="alert alert-danger">
        <ul class="mb-0 small">
            {% for field, errs in form.errors.items %}
            {% for err in errs %}
            <li>{{ field }} â€” {{ err }}</li>
            {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% if error_message %}
    <div class="alert alert-danger small">{{ error_message }}</div>
    {% endif %}
</div>

<script type="module">
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts);
    const escapeHtml = t => String(t ?? "").replace(/[&<>"'`=\/]/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;" }[s] || s));
    const showAlert = (msg, type = "success") => {
        const id = "alert-" + Date.now();
        const html = `<div id="${id}" class="alert alert-${type} alert-dismissible fade show mt-3 shadow-sm" role="alert">${escapeHtml(msg)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        $("#alert-container")?.insertAdjacentHTML("beforeend", html);
        setTimeout(() => document.getElementById(id)?.remove(), 3500);
    };

    const form = $("#purchaseForm");
    const tbody = $("#items-body");
    const purchaseTotalInput = $("#purchase-total");
    const itemsJsonInput = $("#items-json");
    const itemsError = $("#items-error");
    const addItemBtn = $("#btnAddItem");

    const buildUnitSelect = (selected = "") => {
        const select = document.createElement("select");
        select.className = "form-select";
        select.name = "metric_system_unit";
        select.required = true;
        select.innerHTML = `
      <option value="" disabled ${selected ? "" : "selected"}>Select unit...</option>
      <option value="1" ${selected == "1" ? "selected" : ""}>un</option>
      <option value="2" ${selected == "2" ? "selected" : ""}>kg</option>
      <option value="3" ${selected == "3" ? "selected" : ""}>g</option>
      <option value="4" ${selected == "4" ? "selected" : ""}>mg</option>
      <option value="5" ${selected == "5" ? "selected" : ""}>L</option>
      <option value="6" ${selected == "6" ? "selected" : ""}>ml</option>`;
        return select;
    };

    const formatNumber = v => {
        const n = Number(v);
        if (Number.isNaN(n)) return "";
        return n.toFixed(2);
    };

    const parsePtBR = (s) => parseFloat(String(s || "0").replace(/\./g, "").replace(",", ".")) || 0;

    const recalcTotals = () => {
        const rows = $$("#items-body tr[data-row]");
        let sum = 0;
        rows.forEach(tr => {
            const itemTotalRaw = $('input[name="item_total"]', tr)?.value || "0";
            sum += parsePtBR(itemTotalRaw);
        });
        if (!purchaseTotalInput.matches(":focus")) purchaseTotalInput.value = formatNumber(sum);
    };

    on(tbody, "blur", e => {
        if (e.target.classList.contains("item-total-input")) {
            recalcTotals();
        }
    }, true);

    const removeEmptyRowIfAny = () => tbody.querySelector(".empty-row")?.remove();
    const ensureEmptyRowIfNone = () => { if (!tbody.querySelector("tr[data-row]")) tbody.insertAdjacentHTML("beforeend", `<tr class="empty-row"><td colspan="5" class="text-center text-muted py-4">No items yet.</td></tr>`); };

    const addRow = (prefill = null) => {
        removeEmptyRowIfAny();
        const tr = document.createElement("tr");
        tr.setAttribute("data-row", "1");

        const tdIng = document.createElement("td");
        tdIng.innerHTML = `
      <div class="position-relative">
        <input type="text" class="form-control ingredient-input" autocomplete="off"
               placeholder="Type the ingredient name"
               aria-autocomplete="list" aria-expanded="false" value="${prefill?.ingredient_name || ""}">
        <input type="hidden" class="ingredient-id" name="ingredient_id" value="${prefill?.ingredient_id || ""}">
        <div class="list-group position-absolute w-100 d-none ingredient-suggest"
             role="listbox" style="z-index:1050; max-height:260px; overflow:auto;"></div>
        <div class="invalid-feedback d-block d-none ingredient-error">Select an ingredient.</div>
      </div>`;

        const tdUnit = document.createElement("td");
        tdUnit.appendChild(buildUnitSelect(prefill?.metric_system_unit ? String(prefill.metric_system_unit) : ""));

        const tdQty = document.createElement("td");
        tdQty.innerHTML = `<input type="number" class="form-control text-end" step="0.01" min="0" name="quantity" required value="${prefill?.quantity ?? ""}">`;

        const tdTotal = document.createElement("td");
        const totalVal = (prefill && (prefill.total !== undefined)) ? Number(prefill.total) : 0;
        tdTotal.innerHTML = `
      <div class="input-group">
        <span class="input-group-text">$</span>
        <input type="text" class="form-control text-end item-total-input" name="item_total" required inputmode="decimal" placeholder="0,00" value="${new Intl.NumberFormat("en-us", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(totalVal)}">
      </div>`;

        const tdActions = document.createElement("td");
        tdActions.className = "text-end";
        tdActions.innerHTML = `<button type="button" class="btn btn-outline-danger btn-sm btn-remove">Remove</button>`;

        tr.append(tdIng, tdUnit, tdQty, tdTotal, tdActions);
        tbody.appendChild(tr);
    };

    on($("#btnAddItem"), "click", () => addRow());

    on(tbody, "click", e => {
        const btn = e.target.closest(".btn-remove");
        if (!btn) return;
        btn.closest("tr")?.remove();
        ensureEmptyRowIfNone();
        recalcTotals();
    });

    on(tbody, "input", e => {
        if (e.target.name === "quantity" || e.target.name === "item_total") recalcTotals();
    });

    on(form, "submit", e => {
        const rows = $$('#items-body tr[data-row]');
        rows.forEach(tr => {
            const ingId = tr.querySelector('input[name="ingredient_id"]').value.trim();
            if (!ingId) tr.remove();
        });
        const rows2 = $$('#items-body tr[data-row]');
        itemsError.classList.add("d-none");
        itemsError.textContent = "";
        if (!rows2.length) {
            e.preventDefault();
            itemsError.textContent = "Add at least one item.";
            itemsError.classList.remove("d-none");
            return;
        }
        const items = [];
        for (const tr of rows2) {
            const ingredientId = $('input[name="ingredient_id"]', tr)?.value?.trim();
            const unit = $('select[name="metric_system_unit"]', tr)?.value?.trim();
            const quantity = $('input[name="quantity"]', tr)?.value?.trim();
            const totalFormatted = $('input[name="item_total"]', tr)?.value?.trim() || "0";
            const total = parsePtBR(totalFormatted);
            if (!ingredientId || !unit || !quantity || !total) {
                e.preventDefault();
                itemsError.textContent = "Complete all item fields.";
                itemsError.classList.remove("d-none");
                return;
            }
            items.push({
                ingredient_id: Number(ingredientId),
                metric_system_unit: Number(unit),
                quantity: Number(quantity),
                total: Number(total)
            });
        }
        itemsJsonInput.value = JSON.stringify(items);
    });

    // --- Supplier autocomplete (same behavior as create page) ---
    const select = (selector, root = document) => root.querySelector(selector);
    const selectAll = (selector, root = document) => Array.from(root.querySelectorAll(selector));
    const onEvent = (element, event, handler) => element && element.addEventListener(event, handler);
    const debounce = (callback, delay = 250) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => callback(...args), delay); }; };

    const supplierInput = select("#supplier-input");
    const supplierHiddenInput = select("#supplier-id");
    const suggestionsList = select("#supplier-suggest");
    const supplierErrorMessage = select("#supplier-error");
    const purchaseForm = select("form#purchaseForm") || supplierInput.closest("form");

    const renderSupplierSuggestions = (suppliers) => {
        suggestionsList.innerHTML = suppliers.map((supplier, index) => `
      <button type="button" class="list-group-item list-group-item-action" role="option" data-id="${supplier.id}" data-name="${supplier.name}" ${index === 0 ? 'aria-selected="true"' : ''}>${supplier.name}</button>`).join("");
        suggestionsList.classList.toggle("d-none", suppliers.length === 0);
        supplierInput.setAttribute("aria-expanded", String(suppliers.length > 0));
    };

    const fetchSupplierSuggestions = async (query) => {
        if (!query || query.length < 2) { renderSupplierSuggestions([]); return; }
        const url = `{% url 'purchases:supplier_search' %}?q=` + encodeURIComponent(query);
        const response = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await response.json();
        renderSupplierSuggestions(data.results || []);
    };

    const selectSupplier = (button) => {
        if (!button) return;
        supplierInput.value = button.dataset.name || "";
        supplierHiddenInput.value = button.dataset.id || "";
        renderSupplierSuggestions([]);
        supplierErrorMessage?.classList.add("d-none");
    };

    const moveSelection = (direction) => {
        const buttons = selectAll(".list-group-item", suggestionsList);
        if (!buttons.length) return;
        let selectedIndex = buttons.findIndex(btn => btn.getAttribute("aria-selected") === "true");
        selectedIndex = (selectedIndex === -1 ? 0 : selectedIndex);
        buttons[selectedIndex].removeAttribute("aria-selected");
        if (direction === "down") selectedIndex++;
        if (direction === "up") selectedIndex--;
        if (selectedIndex < 0) selectedIndex = buttons.length - 1;
        if (selectedIndex >= buttons.length) selectedIndex = 0;
        buttons[selectedIndex].setAttribute("aria-selected", "true");
        buttons[selectedIndex].scrollIntoView({ block: "nearest" });
    };

    onEvent(supplierInput, "input", debounce((event) => { supplierHiddenInput.value = ""; fetchSupplierSuggestions(event.target.value.trim()); }));
    onEvent(supplierInput, "keydown", (event) => {
        if (event.key === "ArrowDown") { event.preventDefault(); moveSelection("down"); }
        else if (event.key === "ArrowUp") { event.preventDefault(); moveSelection("up"); }
        else if (event.key === "Enter") {
            const activeButton = select('.list-group-item[aria-selected="true"]', suggestionsList);
            if (activeButton) { event.preventDefault(); selectSupplier(activeButton); }
        } else if (event.key === "Escape") { renderSupplierSuggestions([]); }
    });
    onEvent(suggestionsList, "click", (event) => { const clickedButton = event.target.closest(".list-group-item"); if (clickedButton) selectSupplier(clickedButton); });
    onEvent(supplierInput, "blur", () => setTimeout(() => renderSupplierSuggestions([]), 120));
    onEvent(suggestionsList, "blur", () => setTimeout(() => renderSupplierSuggestions([]), 120));
    onEvent(purchaseForm, "submit", (event) => { if (!supplierHiddenInput.value) { event.preventDefault(); supplierErrorMessage.textContent = "Selecione um fornecedor da lista."; supplierErrorMessage.classList.remove("d-none"); supplierInput.focus(); } });

    // --- Ingredient autocomplete (same as create page) ---
    const debounce2 = debounce; // reuse
    const fetchIngredientSuggestions = async (query, listElement) => {
        if (!query || query.length < 2) { listElement.classList.add("d-none"); listElement.innerHTML = ""; return; }
        const url = `{% url 'purchases:ingredient_search' %}?q=` + encodeURIComponent(query);
        const response = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await response.json();
        listElement.innerHTML = data.results.map((item, index) => `
      <button type="button" class="list-group-item list-group-item-action" role="option" data-id="${item.id}" data-name="${item.name}" ${index === 0 ? 'aria-selected="true"' : ''}>${item.name}</button>`).join("");
        listElement.classList.toggle("d-none", data.results.length === 0);
    };

    const handleIngredientSelection = (button, input, hiddenInput, list, errorDiv) => {
        if (!button) return;
        input.value = button.dataset.name;
        hiddenInput.value = button.dataset.id;
        list.classList.add("d-none");
        list.innerHTML = "";
        errorDiv.classList.add("d-none");
    };

    on(tbody, "input", debounce2(e => { if (!e.target.classList.contains("ingredient-input")) return; const row = e.target.closest("tr"); const list = row.querySelector(".ingredient-suggest"); row.querySelector(".ingredient-id").value = ""; fetchIngredientSuggestions(e.target.value.trim(), list); }));

    on(tbody, "keydown", e => {
        const input = e.target.closest(".ingredient-input");
        if (!input) return;
        const row = e.target.closest("tr");
        const list = row.querySelector(".ingredient-suggest");
        const buttons = Array.from(list.querySelectorAll(".list-group-item"));
        if (!buttons.length) return;
        let selectedIndex = buttons.findIndex(btn => btn.getAttribute("aria-selected") === "true");
        selectedIndex = selectedIndex === -1 ? 0 : selectedIndex;
        if (e.key === "ArrowDown") { e.preventDefault(); selectedIndex = (selectedIndex + 1) % buttons.length; }
        else if (e.key === "ArrowUp") { e.preventDefault(); selectedIndex = (selectedIndex - 1 + buttons.length) % buttons.length; }
        else if (e.key === "Enter") { e.preventDefault(); handleIngredientSelection(buttons[selectedIndex], input, row.querySelector(".ingredient-id"), list, row.querySelector(".ingredient-error")); }
        else { return; }
        buttons.forEach(btn => btn.removeAttribute("aria-selected"));
        buttons[selectedIndex].setAttribute("aria-selected", "true");
        buttons[selectedIndex].scrollIntoView({ block: "nearest" });
    });

    on(tbody, "click", e => { const button = e.target.closest(".list-group-item"); if (!button) return; const row = button.closest("tr"); handleIngredientSelection(button, row.querySelector(".ingredient-input"), row.querySelector(".ingredient-id"), row.querySelector(".ingredient-suggest"), row.querySelector(".ingredient-error")); });

    on(tbody, "blur", e => { if (!e.target.classList.contains("ingredient-input")) return; setTimeout(() => { const row = e.target.closest("tr"); row.querySelector(".ingredient-suggest").classList.add("d-none"); }, 150); }, true);

    document.addEventListener('DOMContentLoaded', recalcTotals);
</script>
{% endblock %}