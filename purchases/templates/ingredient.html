{% extends "base.html" %}
{% load static %}

{% block content %}
<main class="container my-4">

    <div class="card mb-4">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
            <h1 class="h5 mb-0">Insumos</h1>

            <div class="d-flex align-items-center gap-2">
                <form class="d-flex" method="get" action="">
                    <input type="search" name="q" value="{{ request.GET.q|default:'' }}" class="form-control"
                        placeholder="Buscar por nome..." aria-label="Buscar insumos">
                    <button class="btn btn-outline-secondary ms-2" type="submit">Buscar</button>
                </form>

                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalFornecedor">
                    + Novo insumo
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table id="tabela-insumos" class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width: 96px;"></th>
                        <th>Nome</th>
                        <th style="width: 220px;" class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% if insumos %}
                    {% for i in insumos %}
                    <tr data-id="{{ i.id }}">
                        <td class="text-muted">#{{ i.id }}</td>
                        <td>{{ i.nome }}</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-editar-insumo"
                                data-id="{{ i.id }}" data-nome="{{ i.nome }}">
                                Alterar
                            </button>

                            <button type="button" class="btn btn-sm btn-outline-danger btn-excluir-insumo"
                                data-id="{{ i.id }}" data-nome="{{ i.nome }}">
                                Excluir
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="row-vazia">
                        <td colspan="3" class="text-center text-muted py-4">
                            Nenhum insumo encontrado.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if page_obj %}
        <div class="card-body">
            <nav aria-label="Paginação de insumos">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
                            aria-label="Anterior">«</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">«</span></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if num == page_obj.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">
                            {{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                            aria-label="Próxima">»</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">»</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    <div class="modal fade" id="modalConfirmarExclusao" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-white">
                    <h5 class="modal-title" id="modalLabel">Confirmar exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    Tem certeza de que deseja excluir o insumo <strong id="exc-nome"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalFornecedor" tabindex="-1" aria-labelledby="modalFornecedorLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <form id="formFornecedor" class="modal-content">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFornecedorLabel">Novo insumo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="novo-nome" class="form-label">Nome</label>
                        <input type="text" class="form-control" id="novo-nome" name="nome" maxlength="100" required>
                        <div class="invalid-feedback" id="novo-erro-nome"></div>
                    </div>
                    <div class="alert alert-danger d-none" id="novo-erro-geral"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnNovoSalvar">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="modalEditarFornecedor" tabindex="-1" aria-labelledby="edtFornecedorLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <form id="formEditarFornecedor" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="id" id="edt-id">
                <div class="modal-header">
                    <h5 class="modal-title" id="edtFornecedorLabel">Editar insumo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edt-nome" class="form-label">Nome</label>
                        <input type="text" class="form-control" id="edt-nome" name="nome" maxlength="100" required>
                        <div class="invalid-feedback" id="edt-erro-nome"></div>
                    </div>
                    <div class="alert alert-danger d-none" id="edt-erro-geral"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnEditarSalvar">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080;"></div>

    <script defer>
        (() => {
            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

            const escapeHtml = (str = '') =>
                str.replace(/[&<>"'`=\/]/g, s => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
                }[s] || s));

            const showAlert = (message, type = 'success') => {
                const id = 'alert-' + Date.now();
                const html = `
        <div id="${id}" class="alert alert-${type} alert-dismissible fade show mt-3 shadow-sm" role="alert">
          ${escapeHtml(message)}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        </div>`;
                $('#alert-container').insertAdjacentHTML('beforeend', html);
                setTimeout(() => document.getElementById(id)?.remove(), 3500);
            };

            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let c of cookies) {
                        const cookie = c.trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            };

            const getCsrfToken = () =>
                document.querySelector('input[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';

            const tabela = $('#tabela-insumos tbody');
            const modalNovoEl = $('#modalFornecedor');
            const modalEditarEl = $('#modalEditarFornecedor');
            const modalExcluirEl = $('#modalConfirmarExclusao');

            const bsModalNovo = () => bootstrap.Modal.getOrCreateInstance(modalNovoEl);
            const bsModalEditar = () => bootstrap.Modal.getOrCreateInstance(modalEditarEl);
            const bsModalExc = () => bootstrap.Modal.getOrCreateInstance(modalExcluirEl);

            (function NovoFornecedor() {
                const form = $('#formFornecedor');
                const btnSalvar = $('#btnNovoSalvar');
                const inpNome = $('#novo-nome');
                const errNome = $('#novo-erro-nome');
                const errGeral = $('#novo-erro-geral');

                const clearErrors = () => {
                    inpNome.classList.remove('is-invalid');
                    errNome.textContent = '';
                    errGeral.classList.add('d-none');
                    errGeral.textContent = '';
                };

                modalNovoEl.addEventListener('show.bs.modal', () => {
                    form.reset();
                    clearErrors();
                    setTimeout(() => inpNome.focus(), 100);
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    clearErrors();

                    const nome = (inpNome.value || '').trim();
                    if (!nome) {
                        inpNome.classList.add('is-invalid');
                        errNome.textContent = 'Informe o nome do insumo.';
                        return;
                    }

                    btnSalvar.disabled = true;

                    try {
                        const fd = new FormData(form);
                        const resp = await fetch('/compra/insumo/cadastrar/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCsrfToken(),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: fd
                        });

                        let data = {};
                        try { data = await resp.json(); } catch { }

                        if (!resp.ok || !data.ok) {
                            if (data?.errors?.nome) {
                                inpNome.classList.add('is-invalid');
                                errNome.textContent = data.errors.nome.join(' ');
                            } else {
                                errGeral.classList.remove('d-none');
                                errGeral.textContent = 'Não foi possível salvar. Tente novamente.';
                            }
                            return;
                        }

                        bsModalNovo().hide();
                        showAlert('Insumo cadastrado com sucesso!');

                        const rowVazia = tabela.querySelector('.row-vazia');
                        if (rowVazia) rowVazia.remove();

                        const id = escapeHtml(String(data.id));
                        const nomeEsc = escapeHtml(String(data.nome));
                        const novaLinha = `
            <tr data-id="${id}">
              <td class="text-muted">#${id}</td>
              <td>${nomeEsc}</td>
              <td class="text-end">
                <button type="button"
                        class="btn btn-sm btn-outline-primary btn-editar-insumo"
                        data-id="${id}" data-nome="${nomeEsc}">Alterar</button>
                <button type="button"
                        class="btn btn-sm btn-outline-danger btn-excluir-insumo"
                        data-id="${id}" data-nome="${nomeEsc}">Excluir</button>
              </td>
            </tr>`;
                        tabela.insertAdjacentHTML('afterbegin', novaLinha);

                    } catch {
                        errGeral.classList.remove('d-none');
                        errGeral.textContent = 'Erro de rede ou servidor. Tente novamente.';
                    } finally {
                        btnSalvar.disabled = false;
                    }
                });
            })();

            (function EditarFornecedor() {
                const form = $('#formEditarFornecedor');
                const btnSalvar = $('#btnEditarSalvar');
                const inpId = $('#edt-id');
                const inpNome = $('#edt-nome');
                const errNome = $('#edt-erro-nome');
                const errGeral = $('#edt-erro-geral');

                const clearErrors = () => {
                    inpNome.classList.remove('is-invalid');
                    errNome.textContent = '';
                    errGeral.classList.add('d-none');
                    errGeral.textContent = '';
                };

                modalEditarEl.addEventListener('show.bs.modal', clearErrors);

                document.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btn-editar-insumo');
                    if (!btn) return;

                    clearErrors();
                    inpId.value = btn.dataset.id || '';
                    inpNome.value = btn.dataset.nome || '';
                    bsModalEditar().show();
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    clearErrors();

                    const id = (inpId.value || '').trim();
                    const nome = (inpNome.value || '').trim();

                    if (!id) { errGeral.classList.remove('d-none'); errGeral.textContent = 'ID inválido.'; return; }
                    if (!nome) { inpNome.classList.add('is-invalid'); errNome.textContent = 'Informe o nome.'; return; }

                    btnSalvar.disabled = true;

                    try {
                        const fd = new FormData(form);
                        const resp = await fetch(`/compra/insumo/alterar/${encodeURIComponent(id)}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCsrfToken(),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: fd
                        });

                        let data = {};
                        try { data = await resp.json(); } catch { }

                        if (!resp.ok || !data.ok) {
                            if (data?.errors?.nome) {
                                inpNome.classList.add('is-invalid');
                                errNome.textContent = data.errors.nome.join(' ');
                            } else {
                                errGeral.classList.remove('d-none');
                                errGeral.textContent = 'Não foi possível salvar. Tente novamente.';
                            }
                            return;
                        }

                        bsModalEditar().hide();
                        showAlert('Insumo atualizado com sucesso!');

                        const row = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
                        if (row) {
                            const nomeCell = row.querySelector('td:nth-child(2)');
                            if (nomeCell) nomeCell.textContent = data.nome;
                            const btnEditar = row.querySelector('.btn-editar-insumo');
                            if (btnEditar) btnEditar.dataset.nome = data.nome;
                            const btnExcluir = row.querySelector('.btn-excluir-insumo');
                            if (btnExcluir) btnExcluir.dataset.nome = data.nome;
                        }

                    } catch {
                        errGeral.classList.remove('d-none');
                        errGeral.textContent = 'Erro de rede ou servidor. Tente novamente.';
                    } finally {
                        btnSalvar.disabled = false;
                    }
                });
            })();

            (function ExcluirFornecedor() {
                let fornecedorIdSelecionado = null;

                document.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btn-excluir-insumo');
                    if (!btn) return;

                    fornecedorIdSelecionado = btn.dataset.id || '';
                    $('#exc-nome').textContent = btn.dataset.nome || '';
                    bsModalExc().show();
                });

                $('#btnConfirmarExclusao').addEventListener('click', async () => {
                    const id = fornecedorIdSelecionado;
                    if (!id) return;

                    try {
                        const resp = await fetch(`/compra/insumo/remover/${encodeURIComponent(id)}/`, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': getCsrfToken() }
                        });

                        if (resp.ok) {
                            document.querySelector(`tr[data-id="${CSS.escape(id)}"]`)?.remove();

                            if (tabela.children.length === 0) {
                                tabela.insertAdjacentHTML('beforeend', `
                <tr class="row-vazia">
                  <td colspan="3" class="text-center text-muted py-4">Nenhum insumo encontrado.</td>
                </tr>`);
                            }

                            showAlert('Insumo removido com sucesso!');
                        } else {
                            showAlert('Erro ao remover insumo.', 'danger');
                        }
                    } catch {
                        showAlert('Falha na comunicação com o servidor.', 'danger');
                    } finally {
                        bsModalExc().hide();
                        fornecedorIdSelecionado = null;
                    }
                });
            })();

        })();
    </script>
</main>
{% endblock content %}