{% extends "base.html" %}

{% load static %}

{% block content %}
<main class="container my-4">

    <div class="card mb-4">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
            <h1 class="h5 mb-0">Ingredients</h1>

            <div class="d-flex align-items-center gap-2">
                <form class="d-flex" method="get" action="">
                    <input type="search" name="q" value="{{ request.GET.q|default:'' }}" class="form-control"
                        placeholder="Search by name..." aria-label="Search ingredients">
                    <button class="btn btn-outline-secondary ms-2" type="submit">Search</button>
                </form>

                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ingredientNewModal">
                    + New ingredient
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table id="ingredients-table" class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width: 96px;"></th>
                        <th>Name</th>
                        <th style="width: 220px;" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if ingredients %}
                    {% for s in ingredients %}
                    <tr data-id="{{ s.id }}">
                        <td class="text-muted">#{{ s.id }}</td>
                        <td>{{ s.name }}</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-ingredient-edit"
                                data-id="{{ s.id }}" data-name="{{ s.name }}">
                                Edit
                            </button>

                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-ingredient"
                                data-id="{{ s.id }}" data-name="{{ s.name }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted py-4">
                            No ingredients found.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if page_obj %}
        <div class="card-body">
            <nav aria-label="Ingredients pagination">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
                            aria-label="Previous">«</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">«</span></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if num == page_obj.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">
                            {{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                            aria-label="Next">»</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">»</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-white">
                    <h5 class="modal-title" id="modalLabel">Confirm deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the ingredient <strong id="del-name"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ingredientNewModal" tabindex="-1" aria-labelledby="ingredientNewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <form id="ingredientNewForm" class="modal-content">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="ingredientNewModalLabel">New ingredient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="new-name" name="name" maxlength="100" required>
                        <div class="invalid-feedback" id="new-name-error"></div>
                    </div>
                    <div class="alert alert-danger d-none" id="new-general-error"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveNew">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="ingredientEditModal" tabindex="-1" aria-labelledby="edtIngredientLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <form id="ingredientEditForm" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="id" id="edt-id">
                <div class="modal-header">
                    <h5 class="modal-title" id="edtIngredientLabel">Edit ingredient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edt-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="edt-name" name="name" maxlength="100" required>
                        <div class="invalid-feedback" id="edt-error-name"></div>
                    </div>
                    <div class="alert alert-danger d-none" id="edt-error-general"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btnEditSave">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080;"></div>

    <script type="module">
        const select = (selector, root = document) => root.querySelector(selector);
        const selectAll = (selector, root = document) => Array.from(root.querySelectorAll(selector));
        const onEvent = (element, eventName, handler, options) => element && element.addEventListener(eventName, handler, options);
        const delegateEvent = (root, eventName, selector, handler) =>
            onEvent(root, eventName, evt => { const target = evt.target.closest(selector); if (target && root.contains(target)) handler(evt, target); });

        const escapeHTML = text => String(text ?? "").replace(/[&<>"'`=\/]/g, ch => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;"
        }[ch] || ch));

        const showAlertMessage = (message, type = "success") => {
            const alertId = "alert-" + Date.now();
            const markup = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show mt-3 shadow-sm" role="alert">
                ${escapeHTML(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            select("#alert-container")?.insertAdjacentHTML("beforeend", markup);
            setTimeout(() => document.getElementById(alertId)?.remove(), 3500);
        };

        const getCookie = name => {
            const parts = document.cookie?.split(";") ?? [];
            for (const raw of parts) {
                const c = raw.trim();
                if (c.startsWith(name + "=")) return decodeURIComponent(c.slice(name.length + 1));
            }
            return null;
        };

        const getCsrfToken = () =>
            document.querySelector("input[name=csrfmiddlewaretoken]")?.value || getCookie("csrftoken") || "";

        const httpRequest = async (url, { method = "GET", body, headers = {} } = {}) => {
            const response = await fetch(url, {
                method,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    ...(method !== "GET" ? { "X-CSRFToken": getCsrfToken() } : {}),
                    ...headers
                },
                body
            });
            let data = null;
            try { data = await response.json(); } catch { }
            return { ok: response.ok, status: response.status, data };
        };

        const ingredientsTbody = select("#ingredients-table tbody");
        const newIngredientModalElement = select("#ingredientNewModal");
        const editIngredientModalElement = select("#ingredientEditModal");
        const deleteConfirmModalElement = select("#confirmDeleteModal");

        const getNewIngredientModal = () => bootstrap.Modal.getOrCreateInstance(newIngredientModalElement);
        const getEditIngredientModal = () => bootstrap.Modal.getOrCreateInstance(editIngredientModalElement);
        const getDeleteConfirmModal = () => bootstrap.Modal.getOrCreateInstance(deleteConfirmModalElement);

        const ensureEmptyRowIfNeeded = () => {
            if (!ingredientsTbody?.querySelector("tr")) {
                ingredientsTbody.insertAdjacentHTML("beforeend", `
                    <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted py-4">No ingredients found.</td>
                    </tr>`);
            }
        };

        const removeEmptyPlaceholderRow = () => ingredientsTbody?.querySelector(".empty-row")?.remove();

        const insertIngredientRow = (id, name) => {
            const safeId = escapeHTML(String(id));
            const safeName = escapeHTML(String(name));
            const rowHtml = `
                <tr data-id="${safeId}">
                <td class="text-muted">#${safeId}</td>
                <td>${safeName}</td>
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-primary btn-ingredient-edit"
                            data-id="${safeId}" data-name="${safeName}">Edit</button>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-ingredient"
                            data-id="${safeId}" data-name="${safeName}">Delete</button>
                </td>
                </tr>`;
            ingredientsTbody.insertAdjacentHTML("afterbegin", rowHtml);
        };

        const updateIngredientRowName = (id, newName) => {
            const row = document.querySelector(`tr[data-id="${CSS.escape(String(id))}"]`);
            if (!row) return;
            row.querySelector("td:nth-child(2)")?.replaceChildren(document.createTextNode(newName));
            row.querySelector(".btn-ingredient-edit")?.setAttribute("data-name", newName);
            row.querySelector(".btn-delete-ingredient")?.setAttribute("data-name", newName);
        };

        const focusPrimaryButtonOnModalShow = modalEl =>
            onEvent(modalEl, "shown.bs.modal", () => modalEl.querySelector(".modal-footer .btn.btn-primary")?.focus());

        const initNewIngredientModule = () => {
            const newIngredientForm = select("#ingredientNewForm");
            const saveNewIngredientButton = select("#btnSaveNew");
            const newIngredientNameInput = select("#new-name");
            const newIngredientNameError = select("#new-name-error");
            const newIngredientGeneralError = select("#new-general-error");

            const clearNewIngredientErrors = () => {
                newIngredientNameInput.classList.remove("is-invalid");
                newIngredientNameError.textContent = "";
                newIngredientGeneralError.classList.add("d-none");
                newIngredientGeneralError.textContent = "";
            };

            onEvent(newIngredientModalElement, "show.bs.modal", () => {
                newIngredientForm?.reset();
                clearNewIngredientErrors();
                setTimeout(() => newIngredientNameInput?.focus(), 80);
            });

            onEvent(newIngredientForm, "submit", async evt => {
                evt.preventDefault();
                clearNewIngredientErrors();

                const name = newIngredientNameInput.value?.trim() ?? "";
                if (!name) {
                    newIngredientNameInput.classList.add("is-invalid");
                    newIngredientNameError.textContent = "Enter the ingredient name.";
                    return;
                }

                saveNewIngredientButton.disabled = true;
                try {
                    const formData = new FormData(newIngredientForm);
                    const { ok, data } = await httpRequest(`{% url 'purchases:ingredient_create' %}`, {
                        method: "POST",
                        body: formData
                    });

                    if (!ok || !data?.ok) {
                        if (data?.errors?.name) {
                            newIngredientNameInput.classList.add("is-invalid");
                            newIngredientNameError.textContent = data.errors.name.join(" ");
                        } else {
                            newIngredientGeneralError.classList.remove("d-none");
                            newIngredientGeneralError.textContent = "Unable to save. Please try again.";
                        }
                        return;
                    }

                    getNewIngredientModal().hide();
                    showAlertMessage("Ingredient saved successfully!");
                    removeEmptyPlaceholderRow();
                    insertIngredientRow(data.id, data.name);
                } catch {
                    newIngredientGeneralError.classList.remove("d-none");
                    newIngredientGeneralError.textContent = "Network error. Please try again later.";
                } finally {
                    saveNewIngredientButton.disabled = false;
                }
            });
        };

        const initEditIngredientModule = () => {
            const editIngredientForm = select("#ingredientEditForm");
            const saveEditedIngredientButton = select("#btnEditSave");
            const editIngredientIdInput = select("#edt-id");
            const editIngredientNameInput = select("#edt-name");
            const editIngredientNameError = select("#edt-error-name");
            const editIngredientGeneralError = select("#edt-error-general");

            const clearEditIngredientErrors = () => {
                editIngredientNameInput.classList.remove("is-invalid");
                editIngredientNameError.textContent = "";
                editIngredientGeneralError.classList.add("d-none");
                editIngredientGeneralError.textContent = "";
            };

            onEvent(editIngredientModalElement, "show.bs.modal", clearEditIngredientErrors);

            delegateEvent(document, "click", ".btn-ingredient-edit", (_evt, button) => {
                clearEditIngredientErrors();
                editIngredientIdInput.value = button.dataset.id ?? "";
                editIngredientNameInput.value = button.dataset.name ?? "";
                getEditIngredientModal().show();
            });

            onEvent(editIngredientForm, "submit", async evt => {
                evt.preventDefault();
                clearEditIngredientErrors();

                const id = (editIngredientIdInput.value ?? "").trim();
                const name = (editIngredientNameInput.value ?? "").trim();
                if (!id) { editIngredientGeneralError.classList.remove("d-none"); editIngredientGeneralError.textContent = "Invalid ID."; return; }
                if (!name) { editIngredientNameInput.classList.add("is-invalid"); editIngredientNameError.textContent = "Enter a name."; return; }

                saveEditedIngredientButton.disabled = true;
                try {
                    const formData = new FormData(editIngredientForm);
                    const updateUrl = `{% url 'purchases:ingredient_update' 0 %}`.replace("0", encodeURIComponent(id));
                    const { ok, data } = await httpRequest(updateUrl, { method: "POST", body: formData });

                    if (!ok || !data?.ok) {
                        if (data?.errors?.name) {
                            editIngredientNameInput.classList.add("is-invalid");
                            editIngredientNameError.textContent = data.errors.name.join(" ");
                        } else {
                            editIngredientGeneralError.classList.remove("d-none");
                            editIngredientGeneralError.textContent = "Could not save. Please try again.";
                        }
                        return;
                    }

                    getEditIngredientModal().hide();
                    showAlertMessage("Ingredient successfully updated!");
                    updateIngredientRowName(id, data.name);
                } catch {
                    editIngredientGeneralError.classList.remove("d-none");
                    editIngredientGeneralError.textContent = "Network or server error. Please try again.";
                } finally {
                    saveEditedIngredientButton.disabled = false;
                }
            });
        };

        const initDeleteIngredientModule = () => {
            const ingredientNameToDelete = select("#del-name");
            const confirmDeleteButton = select("#btnConfirmDelete");
            let selectedIngredientId = null;

            delegateEvent(document, "click", ".btn-delete-ingredient", (_evt, button) => {
                selectedIngredientId = button.dataset.id ?? "";
                if (ingredientNameToDelete) ingredientNameToDelete.textContent = button.dataset.name ?? "";
                getDeleteConfirmModal().show();
            });

            onEvent(confirmDeleteButton, "click", async () => {
                const id = selectedIngredientId?.trim();
                if (!id) return;

                try {
                    const deleteUrl = `{% url 'purchases:ingredient_delete' 0 %}`.replace("0", encodeURIComponent(id));
                    const { ok } = await httpRequest(deleteUrl, { method: "POST" });

                    if (ok) {
                        document.querySelector(`tr[data-id="${CSS.escape(id)}"]`)?.remove();
                        ensureEmptyRowIfNeeded();
                        showAlertMessage("Ingredient successfully deleted!");
                    } else {
                        showAlertMessage("Error while deleting ingredient.", "danger");
                    }
                } catch {
                    showAlertMessage("Failed to communicate with the server.", "danger");
                } finally {
                    getDeleteConfirmModal().hide();
                    selectedIngredientId = null;
                }
            });
        };

        const initModalFocusUX = () => {
            focusPrimaryButtonOnModalShow(newIngredientModalElement);
            focusPrimaryButtonOnModalShow(editIngredientModalElement);
            focusPrimaryButtonOnModalShow(deleteConfirmModalElement);
        };

        const initializeIngredientsPage = () => {
            initNewIngredientModule();
            initEditIngredientModule();
            initDeleteIngredientModule();
            initModalFocusUX();
        };

        document.addEventListener("DOMContentLoaded", initializeIngredientsPage);
    </script>

</main>
{% endblock content %}