{% extends "base.html" %}

{% load static %}

{% block content %}
<main class="container my-4">

    <div class="card mb-4">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
            <h1 class="h5 mb-0">Suppliers</h1>

            <div class="d-flex align-items-center gap-2">
                <form class="d-flex" method="get" action="">
                    <input type="search" name="q" value="{{ request.GET.q|default:'' }}" class="form-control"
                        placeholder="Search by name..." aria-label="Search suppliers">
                    <button class="btn btn-outline-secondary ms-2" type="submit">Search</button>
                </form>

                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#supplierNewModal">
                    + New supplier
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table id="suppliers-table" class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width: 96px;"></th>
                        <th>Name</th>
                        <th style="width: 220px;" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if suppliers %}
                    {% for s in suppliers %}
                    <tr data-id="{{ s.id }}">
                        <td class="text-muted">#{{ s.id }}</td>
                        <td>{{ s.name }}</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-supplier-edit"
                                data-id="{{ s.id }}" data-name="{{ s.name }}">
                                Edit
                            </button>

                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-supplier"
                                data-id="{{ s.id }}" data-name="{{ s.name }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted py-4">
                            No suppliers found.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if page_obj %}
        <div class="card-body">
            <nav aria-label="Suppliers pagination">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
                            aria-label="Previous">«</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">«</span></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if num == page_obj.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">
                            {{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                            aria-label="Next">»</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">»</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-white">
                    <h5 class="modal-title" id="modalLabel">Confirm deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the supplier <strong id="del-name"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="supplierNewModal" tabindex="-1" aria-labelledby="supplierNewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <form id="supplierNewForm" class="modal-content">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierNewModalLabel">New supplier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="new-name" name="name" maxlength="100" required>
                        <div class="invalid-feedback" id="new-name-error"></div>
                    </div>
                    <div class="alert alert-danger d-none" id="new-general-error"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveNew">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="supplierEditModal" tabindex="-1" aria-labelledby="edtSupplierLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="supplierEditForm" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="id" id="edt-id">
                <div class="modal-header">
                    <h5 class="modal-title" id="edtSupplierLabel">Edit supplier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edt-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="edt-name" name="name" maxlength="100" required>
                        <div class="invalid-feedback" id="edt-error-name"></div>
                    </div>
                    <div class="alert alert-danger d-none" id="edt-error-general"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btnEditSave">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080;"></div>

    <script type="module">
        const select = (selector, root = document) => root.querySelector(selector);
        const selectAll = (selector, root = document) => Array.from(root.querySelectorAll(selector));
        const onEvent = (element, eventName, handler, options) => element && element.addEventListener(eventName, handler, options);
        const delegateEvent = (root, eventName, selector, handler) =>
            onEvent(root, eventName, evt => { const target = evt.target.closest(selector); if (target && root.contains(target)) handler(evt, target); });

        const escapeHTML = text => String(text ?? "").replace(/[&<>"'`=\/]/g, ch => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;"
        }[ch] || ch));

        const showAlertMessage = (message, type = "success") => {
            const alertId = "alert-" + Date.now();
            const markup = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show mt-3 shadow-sm" role="alert">
                ${escapeHTML(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            select("#alert-container")?.insertAdjacentHTML("beforeend", markup);
            setTimeout(() => document.getElementById(alertId)?.remove(), 3500);
        };

        const getCookie = name => {
            const parts = document.cookie?.split(";") ?? [];
            for (const raw of parts) {
                const c = raw.trim();
                if (c.startsWith(name + "=")) return decodeURIComponent(c.slice(name.length + 1));
            }
            return null;
        };

        const getCsrfToken = () =>
            document.querySelector("input[name=csrfmiddlewaretoken]")?.value || getCookie("csrftoken") || "";

        const httpRequest = async (url, { method = "GET", body, headers = {} } = {}) => {
            const response = await fetch(url, {
                method,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    ...(method !== "GET" ? { "X-CSRFToken": getCsrfToken() } : {}),
                    ...headers
                },
                body
            });
            let data = null;
            try { data = await response.json(); } catch { }
            return { ok: response.ok, status: response.status, data };
        };

        const suppliersTbody = select("#suppliers-table tbody");
        const newSupplierModalElement = select("#supplierNewModal");
        const editSupplierModalElement = select("#supplierEditModal");
        const deleteConfirmModalElement = select("#confirmDeleteModal");

        const getNewSupplierModal = () => bootstrap.Modal.getOrCreateInstance(newSupplierModalElement);
        const getEditSupplierModal = () => bootstrap.Modal.getOrCreateInstance(editSupplierModalElement);
        const getDeleteConfirmModal = () => bootstrap.Modal.getOrCreateInstance(deleteConfirmModalElement);

        const ensureEmptyRowIfNeeded = () => {
            if (!suppliersTbody?.querySelector("tr")) {
                suppliersTbody.insertAdjacentHTML("beforeend", `
                    <tr class="empty-row">
                        <td colspan="3" class="text-center text-muted py-4">No suppliers found.</td>
                    </tr>`);
            }
        };

        const removeEmptyPlaceholderRow = () => suppliersTbody?.querySelector(".empty-row")?.remove();

        const insertSupplierRow = (id, name) => {
            const safeId = escapeHTML(String(id));
            const safeName = escapeHTML(String(name));
            const rowHtml = `
                <tr data-id="${safeId}">
                <td class="text-muted">#${safeId}</td>
                <td>${safeName}</td>
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-primary btn-supplier-edit"
                            data-id="${safeId}" data-name="${safeName}">Edit</button>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-supplier"
                            data-id="${safeId}" data-name="${safeName}">Delete</button>
                </td>
                </tr>`;
            suppliersTbody.insertAdjacentHTML("afterbegin", rowHtml);
        };

        const updateSupplierRowName = (id, newName) => {
            const row = document.querySelector(`tr[data-id="${CSS.escape(String(id))}"]`);
            if (!row) return;
            row.querySelector("td:nth-child(2)")?.replaceChildren(document.createTextNode(newName));
            row.querySelector(".btn-supplier-edit")?.setAttribute("data-name", newName);
            row.querySelector(".btn-delete-supplier")?.setAttribute("data-name", newName);
        };

        const focusPrimaryButtonOnModalShow = modalEl =>
            onEvent(modalEl, "shown.bs.modal", () => modalEl.querySelector(".modal-footer .btn.btn-primary")?.focus());

        const initNewSupplierModule = () => {
            const newSupplierForm = select("#supplierNewForm");
            const saveNewSupplierButton = select("#btnSaveNew");
            const newSupplierNameInput = select("#new-name");
            const newSupplierNameError = select("#new-name-error");
            const newSupplierGeneralError = select("#new-general-error");

            const clearNewSupplierErrors = () => {
                newSupplierNameInput.classList.remove("is-invalid");
                newSupplierNameError.textContent = "";
                newSupplierGeneralError.classList.add("d-none");
                newSupplierGeneralError.textContent = "";
            };

            onEvent(newSupplierModalElement, "show.bs.modal", () => {
                newSupplierForm?.reset();
                clearNewSupplierErrors();
                setTimeout(() => newSupplierNameInput?.focus(), 80);
            });

            onEvent(newSupplierForm, "submit", async evt => {
                evt.preventDefault();
                clearNewSupplierErrors();

                const name = newSupplierNameInput.value?.trim() ?? "";
                if (!name) {
                    newSupplierNameInput.classList.add("is-invalid");
                    newSupplierNameError.textContent = "Enter the supplier name.";
                    return;
                }

                saveNewSupplierButton.disabled = true;
                try {
                    const formData = new FormData(newSupplierForm);
                    const { ok, data } = await httpRequest(`{% url 'purchases:supplier_create' %}`, {
                        method: "POST",
                        body: formData
                    });

                    if (!ok || !data?.ok) {
                        if (data?.errors?.name) {
                            newSupplierNameInput.classList.add("is-invalid");
                            newSupplierNameError.textContent = data.errors.name.join(" ");
                        } else {
                            newSupplierGeneralError.classList.remove("d-none");
                            newSupplierGeneralError.textContent = "Unable to save. Please try again.";
                        }
                        return;
                    }

                    getNewSupplierModal().hide();
                    showAlertMessage("Supplier saved successfully!");
                    removeEmptyPlaceholderRow();
                    insertSupplierRow(data.id, data.name);
                } catch {
                    newSupplierGeneralError.classList.remove("d-none");
                    newSupplierGeneralError.textContent = "Network error. Please try again later.";
                } finally {
                    saveNewSupplierButton.disabled = false;
                }
            });
        };

        const initEditSupplierModule = () => {
            const editSupplierForm = select("#supplierEditForm");
            const saveEditedSupplierButton = select("#btnEditSave");
            const editSupplierIdInput = select("#edt-id");
            const editSupplierNameInput = select("#edt-name");
            const editSupplierNameError = select("#edt-error-name");
            const editSupplierGeneralError = select("#edt-error-general");

            const clearEditSupplierErrors = () => {
                editSupplierNameInput.classList.remove("is-invalid");
                editSupplierNameError.textContent = "";
                editSupplierGeneralError.classList.add("d-none");
                editSupplierGeneralError.textContent = "";
            };

            onEvent(editSupplierModalElement, "show.bs.modal", clearEditSupplierErrors);

            delegateEvent(document, "click", ".btn-supplier-edit", (_evt, button) => {
                clearEditSupplierErrors();
                editSupplierIdInput.value = button.dataset.id ?? "";
                editSupplierNameInput.value = button.dataset.name ?? "";
                getEditSupplierModal().show();
            });

            onEvent(editSupplierForm, "submit", async evt => {
                evt.preventDefault();
                clearEditSupplierErrors();

                const id = (editSupplierIdInput.value ?? "").trim();
                const name = (editSupplierNameInput.value ?? "").trim();
                if (!id) { editSupplierGeneralError.classList.remove("d-none"); editSupplierGeneralError.textContent = "Invalid ID."; return; }
                if (!name) { editSupplierNameInput.classList.add("is-invalid"); editSupplierNameError.textContent = "Enter a name."; return; }

                saveEditedSupplierButton.disabled = true;
                try {
                    const formData = new FormData(editSupplierForm);
                    const updateUrl = `{% url 'purchases:supplier_update' 0 %}`.replace("0", encodeURIComponent(id));
                    const { ok, data } = await httpRequest(updateUrl, { method: "POST", body: formData });

                    if (!ok || !data?.ok) {
                        if (data?.errors?.name) {
                            editSupplierNameInput.classList.add("is-invalid");
                            editSupplierNameError.textContent = data.errors.name.join(" ");
                        } else {
                            editSupplierGeneralError.classList.remove("d-none");
                            editSupplierGeneralError.textContent = "Could not save. Please try again.";
                        }
                        return;
                    }

                    getEditSupplierModal().hide();
                    showAlertMessage("Supplier successfully updated!");
                    updateSupplierRowName(id, data.name);
                } catch {
                    editSupplierGeneralError.classList.remove("d-none");
                    editSupplierGeneralError.textContent = "Network or server error. Please try again.";
                } finally {
                    saveEditedSupplierButton.disabled = false;
                }
            });
        };

        const initDeleteSupplierModule = () => {
            const supplierNameToDelete = select("#del-name");
            const confirmDeleteButton = select("#btnConfirmDelete");
            let selectedSupplierId = null;

            delegateEvent(document, "click", ".btn-delete-supplier", (_evt, button) => {
                selectedSupplierId = button.dataset.id ?? "";
                if (supplierNameToDelete) supplierNameToDelete.textContent = button.dataset.name ?? "";
                getDeleteConfirmModal().show();
            });

            onEvent(confirmDeleteButton, "click", async () => {
                const id = selectedSupplierId?.trim();
                if (!id) return;

                try {
                    const deleteUrl = `{% url 'purchases:supplier_delete' 0 %}`.replace("0", encodeURIComponent(id));
                    const { ok } = await httpRequest(deleteUrl, { method: "POST" });

                    if (ok) {
                        document.querySelector(`tr[data-id="${CSS.escape(id)}"]`)?.remove();
                        ensureEmptyRowIfNeeded();
                        showAlertMessage("Supplier successfully deleted!");
                    } else {
                        showAlertMessage("Error while deleting supplier.", "danger");
                    }
                } catch {
                    showAlertMessage("Failed to communicate with the server.", "danger");
                } finally {
                    getDeleteConfirmModal().hide();
                    selectedSupplierId = null;
                }
            });
        };

        const initModalFocusUX = () => {
            focusPrimaryButtonOnModalShow(newSupplierModalElement);
            focusPrimaryButtonOnModalShow(editSupplierModalElement);
            focusPrimaryButtonOnModalShow(deleteConfirmModalElement);
        };

        const initializeSuppliersPage = () => {
            initNewSupplierModule();
            initEditSupplierModule();
            initDeleteSupplierModule();
            initModalFocusUX();
        };

        document.addEventListener("DOMContentLoaded", initializeSuppliersPage);
    </script>

</main>
{% endblock content %}